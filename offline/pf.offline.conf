# Offline profile: Tailscale-only + LM Studio/Hugging Face egress
# Installed to /etc/pf.offline.conf by offline/offline-firewall.sh

# Interface/addr macros are populated in /etc/pf.offline.vars
include "/etc/pf.offline.vars"

# Host allowlists
# - tailscale: control-plane / DERP endpoints (populated by sync-pf-tables.sh)
# Start empty to avoid DNS resolution failures at load time
table <tailscale_hosts> persist

set block-policy drop
set skip on lo0

block in all
block out all

# Keep the Tailscale tunnel usable (data plane on utun)
pass quick on $ts_if proto { tcp udp icmp } from any to any keep state

# Minimal bootstrap for Tailscale control/DERP over WAN
# Restrict to tailscale_hosts table to prevent UDP exfiltration
pass out on $wan_if proto udp to <tailscale_hosts> port { 3478, 41641 } keep state
pass out on $wan_if proto tcp to <tailscale_hosts> port 443 keep state

# Anchor for temporary update window (Homebrew, git, extra repos)
anchor "offline-updates"
load anchor "offline-updates" from "/etc/pf.offline-updates.conf"
