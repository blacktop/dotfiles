# Offline profile: Tailscale-only + LM Studio/Hugging Face egress
# Installed to /etc/pf.offline.conf by offline/offline-firewall.sh
#
# IMPORTANT: This configuration uses INTERFACE-SCOPED blocking instead of
# global "block all" to avoid macOS Tahoe (26) PF issues where global blocks
# interfere with utun interface traffic even when pass rules are present.
#
# KEY INSIGHT: Tailscale's control plane connections originate from the LAN IP
# (e.g., 192.168.x.x), not the Tailscale IP (100.x.x.x). The WAN egress rules
# must use the LAN IP as the source address.

# Interface/addr macros are populated in /etc/pf.offline.vars
include "/etc/pf.offline.vars"

# Host allowlists
# - tailscale: control-plane / DERP endpoints (populated by sync-pf-tables.sh)
# Start empty to avoid DNS resolution failures at load time
table <tailscale_hosts> persist

# Options
set block-policy drop
set ruleset-optimization basic
set skip on lo0

# Skip filtering on Tailscale interface entirely - most reliable approach
# This must come before any block rules to ensure Tailscale traffic is never filtered
set skip on $ts_if

# ============================================================================
# INTERFACE-SCOPED BLOCKING (not global "block all")
# ============================================================================
# We block only on the WAN interface. This avoids the macOS Tahoe bug/behavior
# where "block all" or "block in all" / "block out all" interferes with utun
# traffic even when explicit pass rules exist for the utun interface.
#
# By blocking only on $wan_if, we:
# 1. Prevent all non-Tailscale internet traffic by default
# 2. Allow Tailscale tunnel traffic to flow unimpeded (via set skip above)
# 3. Avoid complex rule ordering issues with global blocks

# Block everything on WAN by default
block in log on $wan_if all
block out log on $wan_if all

# ============================================================================
# TAILSCALE CONTROL PLANE & DERP (WAN egress rules)
# ============================================================================
# These rules allow Tailscale to establish and maintain connectivity.
# IMPORTANT: Use $lan_ip (the physical interface IP), not $ts_cidr (Tailscale IP)
# because Tailscale's control plane connections originate from the LAN IP.

# UDP for STUN/NAT traversal and direct peer connections
# Must go to "any" because peer IPs are dynamic and STUN servers vary
pass out quick on $wan_if proto udp from $lan_ip to any port { 3478, 41641 } keep state

# TCP 443 to Tailscale control plane and DERP servers
# Restricted to tailscale_hosts table (populated by sync-pf-tables.sh)
pass out quick on $wan_if proto tcp from $lan_ip to <tailscale_hosts> port 443 keep state

# ============================================================================
# UPDATE WINDOW ANCHOR
# ============================================================================
# Anchor for temporary update window (Homebrew, git, LM Studio, etc.)
# Loaded by: offline-firewall.sh open-updates
# Rules defined in: /etc/pf.offline-updates.conf

anchor "offline-updates"
load anchor "offline-updates" from "/etc/pf.offline-updates.conf"
