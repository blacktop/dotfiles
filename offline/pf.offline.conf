# Offline profile: Tailscale-only + LM Studio/Hugging Face egress
# Installed to /etc/pf.offline.conf by offline/offline-firewall.sh

# Interface/addr macros are populated in /etc/pf.offline.vars
include "/etc/pf.offline.vars"

# Host allowlists
# - tailscale: control-plane / DERP endpoints (populated by sync-pf-tables.sh)
# Start empty to avoid DNS resolution failures at load time
table <tailscale_hosts> persist

set block-policy drop
set ruleset-optimization basic
set skip on lo0

# Block all by default
block in log all
block out log all

# Allow all traffic on Tailscale tunnel interface (bidirectional)
pass in quick on $ts_if all
pass out quick on $ts_if all

# Minimal bootstrap for Tailscale control/DERP over WAN
# UDP must go to any for STUN/NAT traversal and direct peer connections
pass out quick on $wan_if proto udp to any port { 3478, 41641 } keep state
pass out quick on $wan_if proto tcp to <tailscale_hosts> port 443 keep state

# Anchor for temporary update window (Homebrew, git, extra repos)
anchor "offline-updates"
load anchor "offline-updates" from "/etc/pf.offline-updates.conf"
